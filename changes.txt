This document provides a comprehensive blueprint of all architectural, logic, and UI changes made to the AI Clothing Shop. These changes are designed to improve search precision, broaden visual matching, and clean up the user interface.

---

### 1. NEW ARCHITECTURE: GLOBAL COLOR FAMILIES
**Description:** We introduced a mapping layer between "Specific Colors" (database variants like Anthracite, Olive) and "Color Families" (Filter UI categories like Grey, Green). This simplifies the filter panel while keeping data precise.

**File:** `store/constants.py` (CREATE NEW FILE)
```python
# Full mapping of specific color names to broader color families for filtering
COLOR_MAPPING = {
    # Grey Family
    'anthracite': 'Grey', 'charcoal': 'Grey', 'dark grey': 'Grey', 'mid grey': 'Grey',
    'light grey': 'Grey', 'silver': 'Grey', 'slate': 'Grey', 'graphite': 'Grey',
    'ash': 'Grey', 'smoke': 'Grey', 'steel': 'Grey', 'gunmetal': 'Grey',

    # Green Family
    'olive': 'Green', 'light olive': 'Green', 'dark green': 'Green', 'dusty green': 'Green',
    'pale green': 'Green', 'brownish green': 'Green', 'teal green': 'Green', 
    'steel green': 'Green', 'yellow green': 'Green', 'emerald': 'Green', 'lime': 'Green',
    'sage': 'Green', 'mint': 'Green', 'forest green': 'Green', 'army green': 'Green',
    'khaki green': 'Green', 'moss': 'Green', 'fern': 'Green',

    # Blue Family
    'navy': 'Blue', 'light blue': 'Blue', 'pale blue': 'Blue', 'dark turquoise': 'Blue',
    'sky blue': 'Blue', 'teal': 'Blue', 'turquoise': 'Blue', 'indigo': 'Blue',
    'royal blue': 'Blue', 'baby blue': 'Blue', 'cyan': 'Blue', 'midnight blue': 'Blue',
    'denim': 'Blue', 'sapphire': 'Blue',

    # Red Family
    'burgundy': 'Red', 'carmine': 'Red', 'maroon': 'Red', 'crimson': 'Red',
    'scarlet': 'Red', 'brick red': 'Red', 'cherry': 'Red', 'wine': 'Red', 'ruby': 'Red',

    # Pink Family
    'pink': 'Pink', 'dusty rose': 'Pink', 'magenta': 'Pink', 'fuchsia': 'Pink',
    'rose': 'Pink', 'salmon': 'Pink', 'coral': 'Pink', 'hot pink': 'Pink',
    'blush': 'Pink', 'peach': 'Pink',

    # Brown Family
    'brown': 'Brown', 'dark brown': 'Brown', 'dusty brown': 'Brown', 'golden brown': 'Brown',
    'coffee': 'Brown', 'copper': 'Brown', 'mahogany': 'Brown', 'taupe': 'Brown',
    'beige': 'Brown', 'tan': 'Brown', 'khaki': 'Brown', 'camel': 'Brown',
    'chocolate': 'Brown', 'sand': 'Brown', 'bronze': 'Brown', 'cocoa': 'Brown', 'cinnamon': 'Brown',

    # Purple Family
    'dark violet': 'Purple', 'steel violet': 'Purple', 'lavender': 'Purple',
    'lilac': 'Purple', 'violet': 'Purple', 'plum': 'Purple', 'mauve': 'Purple',
    'orchid': 'Purple', 'grape': 'Purple', 'aubergine': 'Purple',

    # Yellow/Orange Family
    'yellow': 'Yellow', 'gold': 'Yellow', 'mustard': 'Yellow', 'canary': 'Yellow',
    'lemon': 'Yellow', 'amber': 'Orange', 'orange': 'Orange', 'rust': 'Orange',
    'burnt orange': 'Orange', 'apricot': 'Orange', 'tangerine': 'Orange',

    # White/Neutral Family
    'cream': 'White', 'nude': 'White', 'ivory': 'White', 'off-white': 'White',
    'eggshell': 'White', 'vanilla': 'White', 'snow': 'White', 'bone': 'White',

    # Black Family
    'black': 'Black', 'jet black': 'Black', 'onyx': 'Black', 'pitch black': 'Black',

    # Special
    'multicolor': 'Multicolor',
}

def get_color_family(specific_color):
    if not specific_color: return "Unknown"
    clean_color = specific_color.lower().strip()
    return COLOR_MAPPING.get(clean_color, clean_color.capitalize())
```

---

### 2. UPDATED BACKEND LOGIC: COLOR FILTERING
**Description:** Modified the main product list view to group variants by family for display and expand families back to specific colors for the database query.

**File:** `store/views.py`
```python
from .constants import COLOR_MAPPING, get_color_family

# Inside product_list view:
# 1. Group DB colors into families for display in sidebar
available_color_families = sorted(list(set(get_color_family(c) for c in all_colors_from_db)))
all_colors = available_color_families # Passed to context as 'all_colors'

# 2. Map user selection back to DB colors
manual_colors_raw = request.GET.getlist('colors')
# ... map AI colors to families too ...
combined_color_families = list(set(manual_colors + ai_color_families))

# 3. Expand for Database Query (OR Logic)
expanded_specific_colors = []
if combined_color_families:
    for family in combined_color_families:
        specifics = [k for k, v in COLOR_MAPPING.items() if v.lower() == family.lower()]
        specifics.append(family.lower()) # Include family name itself
        expanded_specific_colors.extend(specifics)

# 4. Final Query
if expanded_specific_colors:
    products = products.filter(variants__color__in=expanded_specific_colors).distinct()
```

---

### 3. AI PROMPT: TEXT SEARCH OPTIMIZATION
**Description:** Optimized the text search to be stricter with color matching and more user-friendly with suggestions.

**File:** `store/ai_utils.py` (Inside `process_search_query`)
```text
[NEW INSTRUCTIONS IN PROMPT]:
2. **STRICT COLOR DETECTION**: Extract colors ONLY if they are an EXACT match (case-insensitive) for a color in the 'Available Colors' list provided above. If the query mentions a color NOT in the list, DO NOT include it in the 'colors' array. DO NOT infer brightness or color_pattern from these exact color matches.

6. SUGGESTIONS: If the query is VAGUE or implies a specific need without technical detail, suggest ONE attribute from the schema. The 'text' field in the suggestion object will be displayed directly to the user, so ensure it is natural, polite, and helpful.
```

---

### 4. AI PROMPT: BROAD VISUAL SEARCH
**Description:** Updated the visual identification prompt to return **lists** of values for ambiguity and encouraged the AI not to be too restrictive.

**File:** `store/ai_utils.py` (Inside `api_identify_items`)
```text
[NEW INSTRUCTIONS IN PROMPT]:
INSTRUCTIONS FOR BROAD SEARCH:
1. **Do not be overly restrictive.** If an item's style, length, or color is ambiguous or could fit multiple categories (e.g., it looks like both a 'wool_coat' and a 'blazer'), include ALL relevant options in the list.
2. **Multi-value support**: Return 'colors' as a list and each feature value in 'features' as a list of strings/booleans.
3. Aim to provide 1-3 likely options for ambiguous features.

[NEW JSON STRUCTURE]:
{
    "items": [{
        "name": "...", "category": "...",
        "colors": ["Color A", "Color B"],
        "features": { "style_category": ["Style 1", "Style 2"] }
    }]
}
```

---

### 5. BACKEND LOGIC: BROAD VISUAL MATCHING (OR LOGIC)
**Description:** Updated the matching logic to handle the new list-based detection from visual search using `OR` logic.

**File:** `store/views.py` (Inside `_get_matching_products`)
```python
# Handle multiple colors (OR logic)
colors = item.get('colors', [])
if colors:
    color_q = Q()
    for c in colors: color_q |= Q(color__iexact=c)
    variant_filters &= color_q

# Handle multiple feature values (OR logic)
if item.get('features'):
    for feature_key, feature_values in item['features'].items():
        if not isinstance(feature_values, list): feature_values = [feature_values]
        feature_q = Q()
        for val in feature_values:
            value_to_match = normalize_filter_value(val)
            feature_q |= Q(features__contains={feature_key: value_to_match})
        product_filters &= feature_q
```

---

### 6. UI: SHORTENED FILTER LABELS
**Description:** Created a template filter to convert technical keys into user-friendly labels.

**File:** `store/templatetags/store_filters.py`
```python
@register.filter(name='format_label')
def format_label(value):
    if not value: return ""
    # Clean up common keys: 'style_category' -> 'Style', 'has_buttons' -> 'Has buttons'
    label = value.replace('_category', '').replace('has_', 'Has ').replace('is_', 'Is ')
    label = label.replace('_', ' ').strip()
    return f"{label[0].upper() + label[1:]}:"
```

**File:** `store/templates/store/partials/filter_sidebar_content.html`
```html
<label class="form-label fw-bold">
    {{ attr.key|format_label }}
</label>
```

---

### 7. UI: DYNAMIC VISUAL SEARCH CHECKBOXES
**Description:** Updated the frontend to render multiple checkboxes if the AI detects multiple options.

**File:** `store/templates/store/visual_search/index.html` (JavaScript Section)
```javascript
// Iterating over detected lists to create checkboxes
valList.forEach((val, vIdx) => {
    featuresHtml += `
        <div class="form-check">
            <input class="form-check-input filter-checkbox" type="checkbox" value="${val}" 
                   id="${itemId}-${key}-${vIdx}" data-type="feature" data-key="${key}" checked 
                   onchange="updateShopLink('${itemId}', '${item.category}')">
            <label class="form-check-label small" for="${itemId}-${key}-${vIdx}">
                ${key.replace(/_/g, ' ')}: ${val}
            </label>
        </div>`;
});
```
