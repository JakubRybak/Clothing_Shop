==========================================================
DEPLOYMENT PLAN: CLOUD RUN + VM (POSTGRES/REDIS) + GCS
==========================================================

This plan describes how to deploy the AI Clothing Shop to Google Cloud Platform
using a cost-effective hybrid architecture.

----------------------------------------------------------
1. ARCHITECTURE OVERVIEW
----------------------------------------------------------
- App Engine: Google Cloud Run (Serverless, scales to zero).
- Database: PostgreSQL (Installed on a Compute Engine VM).
- Cache: Redis (Installed on the same Compute Engine VM).
- Storage: Google Cloud Storage (Buckets for images/static files).
- AI: Vertex AI (Gemini 2.0 Flash Lite).
- Connection: Serverless VPC Connector (Bridges Cloud Run to the VM).

----------------------------------------------------------
2. PC PREPARATION (DONE)
----------------------------------------------------------
- [x] Dockerfile: Created for packaging the app.
- [x] requirements.txt: Updated with production libraries (gunicorn, django-storages, etc.).
- [x] settings.py: Updated to use Environment Variables for all sensitive data.
- [x] ai_utils.py: Updated to be project-agnostic and use Cloud credentials.

ACTION: Push all current changes to your GitHub repository before starting GCP setup.

----------------------------------------------------------
3. GCP WEBSITE SETUP (STEP-BY-STEP)
----------------------------------------------------------

STEP A: NEW PROJECT
1. Go to GCP Console -> New Project.
2. Name: ai-clothing-shop-prod.
3. ENABLE BILLING.
4. Search for "Vertex AI API" and click ENABLE.

STEP B: THE VM (POSTGRES & REDIS)
1. Go to Compute Engine -> VM Instances -> Create Instance.
2. Machine Type: e2-small (or e2-micro for lowest cost).
3. Networking -> Advanced -> Network Interfaces:
   - Set Internal IP to "RESERVE STATIC INTERNAL IP". (Name it 'shop-vm-ip').
4. Once created, click "SSH" in the browser:
   - Run: sudo apt update
   - Run: sudo apt install postgresql redis-server
   - Update Postgres Config (/etc/postgresql/.../main/postgresql.conf):
     - Set `listen_addresses = '*'`
   - Update Postgres Config (/etc/postgresql/.../main/pg_hba.conf):
     - Add line: `host all all 0.0.0.0/0 md5` (Security handled by VPC firewall).
   - Run: sudo service postgresql restart
   - Run: sudo service redis-server restart

STEP C: THE STORAGE BUCKET
1. Go to Cloud Storage -> Buckets -> Create.
2. Name: (e.g., ai-shop-static-assets).
3. Public Access: Uncheck "Block all public access".
4. Set Access Control to "Uniform".
5. Add Permission: "allUsers" with role "Storage Object Viewer" (so images are visible to users).

STEP D: THE VPC BRIDGE (CRITICAL)
1. Go to VPC Network -> Serverless VPC Access.
2. Click "Create Connector".
3. Region: (Must match your VM and Cloud Run region, e.g., us-central1).
4. This allows Cloud Run to talk to your VM's internal IP.

----------------------------------------------------------
4. DEPLOYING THE APP (CLOUD RUN)
----------------------------------------------------------
1. Go to Cloud Run -> Create Service.
2. Select "Continuously deploy from a repository" -> Set up with GitHub.
3. In "Configuration", set the following Environment Variables:

   KEY                | VALUE
   -------------------|---------------------------------------
   DJANGO_SECRET_KEY  | (Generate a random string)
   DJANGO_DEBUG       | False
   DB_NAME            | (Your VM DB Name)
   DB_USER            | (Your VM DB User)
   DB_PASSWORD        | (Your VM DB Password)
   DB_HOST            | (The STATIC INTERNAL IP of your VM)
   REDIS_URL          | redis://<VM_INTERNAL_IP>:6379/1
   USE_GCS            | True
   GS_BUCKET_NAME     | (Your GCS Bucket Name)
   GCP_PROJECT_ID     | (Your NEW Project ID)
   GCP_LOCATION       | (Your region, e.g., us-central1)

4. In Networking Tab:
   - Select "Connect to a VPC for internal resources".
   - Select the VPC Connector you created in Step D.

5. Click DEPLOY.

----------------------------------------------------------
5. FINALIZING
----------------------------------------------------------
Once the URL is generated by Cloud Run:
1. Go to your VM (SSH) and run migrations one last time:
   (You can also do this via Cloud Run Jobs if preferred).
2. Use the "ðŸ“¸ Visual Search" to test if GCS and AI are working.
3. Check "Search Queries" in Admin to see if the VM database is saving prompts.

==========================================================
PLAN SAVED. READY WHEN YOU ARE.
==========================================================
