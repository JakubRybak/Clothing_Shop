{% extends 'base.html' %}

{% block sidebar %}
    {% include 'store/partials/filter_sidebar.html' %}
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center my-4">
    {% include 'store/partials/page_header.html' %}

    <form method="get" class="d-flex flex-grow-1 mx-4 align-items-start" id="searchForm"
          hx-get="{{ request.path }}"
          hx-target="#product-grid"
          hx-swap="outerHTML"
          hx-push-url="true"
          hx-include="#filter-sidebar form"
          hx-indicator="#search-btn">
        {% include 'store/partials/search_input_area.html' %}
    </form>
</div>

{% include 'store/partials/smart_suggestion_alert.html' %}

<!-- Initialize Tooltips & Logic -->
<script>
    function initializeTooltips() {
        // Destroy existing tooltips to prevent duplicates
        var existingTooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        existingTooltips.forEach(function (tooltipEl) {
            var bsTooltip = bootstrap.Tooltip.getInstance(tooltipEl);
            if (bsTooltip) {
                bsTooltip.dispose();
            }
        });

        // Initialize new tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    }

    document.addEventListener("DOMContentLoaded", function(){
        initializeTooltips(); // Initialize on first load

        // Conflict Modal
        {% if conflict_data %}
            var myModal = new bootstrap.Modal(document.getElementById('conflictModal'));
            myModal.show();
        {% endif %}
    });

    // Initialize tooltips after every HTMX swap
    document.body.addEventListener('htmx:afterSwap', function(event) {
        initializeTooltips();
    });

    function removeQuery(btn) {
        // Show spinner, hide 'x'
        btn.querySelector('.delete-icon').classList.add('d-none');
        btn.querySelector('.spinner-border').classList.remove('d-none');
        btn.disabled = true;

        // Find the hidden input in this group and remove it so it's not sent
        var group = btn.closest('.input-group');
        var input = group.querySelector('input[name="q"]');
        if (input) input.remove();

        // FIX: Temporarily clear the main search input so its unsaved value is not included in the request
        var form = document.getElementById('searchForm');
        var mainInput = form.querySelector('input[type="search"][name="q"]');
        var originalValue = "";
        if (mainInput) {
            originalValue = mainInput.value;
            mainInput.value = "";
        }

        // Use htmx to trigger the form submission
        htmx.trigger(form, 'submit');

        // Restore the value so the user doesn't lose what they were typing
        if (mainInput) {
            setTimeout(function() {
                mainInput.value = originalValue;
            }, 50);
        }
    }

    function addSuggestionAsNewQuery(suggestedQuery) {
        var searchForm = document.getElementById('searchForm');
        var inputArea = document.getElementById('search-input-area');

        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'q';
        input.value = suggestedQuery;
        inputArea.appendChild(input);

        // Add hidden input to indicate suggestion was accepted
        var acceptedInput = document.createElement('input');
        acceptedInput.type = 'hidden';
        acceptedInput.name = 'accepted_suggestion';
        acceptedInput.value = 'true';
        inputArea.appendChild(acceptedInput);

        // Handle Animation: Switch indicator to local spinner
        var suggestionAlert = document.getElementById('smart-suggestion-alert');
        var btn = suggestionAlert.querySelector('button');
        var spinner = document.getElementById('suggestion-spinner');

        if (btn) btn.style.display = 'none';
        if (spinner) spinner.style.display = 'block';

        // Temporarily change the form's indicator to avoid triggering the main search spinner
        var originalIndicator = searchForm.getAttribute('hx-indicator');
        searchForm.setAttribute('hx-indicator', '#suggestion-spinner');

        // Reset indicator after request
        searchForm.addEventListener('htmx:afterRequest', function cleanup() {
            searchForm.setAttribute('hx-indicator', originalIndicator);
            searchForm.removeEventListener('htmx:afterRequest', cleanup);
        });

        htmx.trigger(searchForm, 'submit');
    }
</script>

{% include 'store/partials/conflict_modal.html' %}

<div class="row">
    <!-- Product Grid -->
    <div class="col-12" id="grid-container">
        {% include 'store/partials/product_grid.html' %}
    </div>
</div>

{% endblock %}